# Integrated Transport and Health Impacts Model

## R Package _ITHIM_
This document will eventually serve as a compendium to the R package
_ITHIM_.  It will describe how to use the package to implement the
ITHIM model, as well as a detailed description of the model itself.

As a working document it will serve as a place for SGY to post
results, questions, interpreations, notes, etc.

```{r libs, eval = TRUE, echo = FALSE, results = "hide", warning = FALSE, error = FALSE, message = FALSE}
options(repos='http://cran.rstudio.com/')
library("ggplot2")
library("reshape2")
library("plyr")
```
```{r loadITHIM, message = FALSE, eval = TRUE, warning = FALSE, error = TRUE}
library("devtools")
install("~/ITHIM/")
# install_github("syounkin/ITHIM", ref = "devel", force = TRUE)
library("ITHIM")
date()
```

### Running in R

```{r instantiate}
ITHIM.baseline <- list(
  parameters = parameters <- createParameterList(baseline = TRUE),
  means = means <- computeMeanMatrices(parameters),
  quintiles = quintiles <- getQuintiles(means)
)
ITHIM.scenario <- list(
  parameters = parameters <- createParameterList(baseline = FALSE),
  means = means <- computeMeanMatrices(parameters),
  quintiles = quintiles <- getQuintiles(means)
)
```
Now we can compute the attributable fraction (AF).

```{r RRs}
comparitiveRisk <- compareModels(ITHIM.baseline,ITHIM.scenario)
names(comparitiveRisk)
```

```{r show}
100*round(comparitiveRisk$AF$BreastCancer,4)
```

Note that some of the AF values will disagree with the EXCEL
spreadsheet because Diabetes, HHD_Air, CVD_Air and Stroke_Air do not
combine travel METs with non-travel METs.

```{r AF, echo = FALSE}
lapply(comparitiveRisk$AF[-(which(names(comparitiveRisk$AF)%in%c("CVD","Diabetes")))], function(x) 100*round(x[-(1:2),],4))
```
### Relative Risk Model
```{r explore}
names(ITHIM.baseline$parameters)
```
```{r RRFigure, echo = FALSE}
phi <- function(x,k=0.5,phi0=comparitiveRisk$RR.baseline$BreastCancer$F[1,1]) phi0^{x^k}
plot(x = xvec <- seq(0,xmax <- 10,length.out=1e3), y = phi(xvec, k = 0.25), main = "Relative Risk Models for MET Exposure", xlab = "METs per week", ylab = "Breast Cancer Relative Risk", type = "l", lwd = 2, col = 1, ylim = c(0.9,1),xlim=c(0,xmax))
lines(x = xvec <- seq(0,xmax,length.out=1e3), y = phi(x = xvec, k = 0.375), lwd = 2, col = 3)
lines(x = xvec <- seq(0,xmax,length.out=1e3), y = phi(x = xvec, k = 0.5), lwd = 2, col = 2)
lines(x = xvec <- seq(0,xmax,length.out=1e3), y = phi(x = xvec, k = 1), lwd = 2, col = 4)
legend(x="topright",legend=paste0("k=",c("0.25","0.375","0.5","1")), col=1:4,lty=1,lwd=2)
```

To see the help page for a function use help().
```{r help, eval = FALSE}
help(createParameterList)
```

### Example
To run the example contained in the _ITHIM_ package run the following.

```{r package, eval = FALSE}
example("ITHIM-package")
```
### Figures

```{r plot2, echo = FALSE, fig.width = 12}
plotRR(comparitiveRisk$RR.baseline$Depression,comparitiveRisk$RR.scenario$Depression) + coord_cartesian(ylim = c(0.75, 1.05))+ggtitle("Depression")
```

```{r plot3, echo = FALSE, fig.width = 12, eval = FALSE}
plotRR(comparitiveRisk$RR.baseline$BreastCancer,comparitiveRisk$RR.scenario$BreastCancer) + coord_cartesian(ylim = c(0.75, 1.05)) + ggtitle("Breast Cancer")
```

```{r plot4, echo = FALSE, fig.height = 12}
D<-melt(comparitiveRisk$AF)
names(D)<- c("age","sex","AF","disease")
p <- ggplot(D, aes(age,AF)) + geom_bar(aes(fill=sex), stat = "identity") + facet_grid( disease ~ .) + coord_cartesian(ylim = c(0, 0.1))
p
```
# Code Graveyard

### Active Transport Estimates (Speed and Distance by Transport Mode)
```{r plot1, echo = FALSE, eval = FALSE}
D <- melt(ITHIM.baseline$means$meanActiveTransportTime, c("age","sex"), value.name = "activeTransportTime")
p <- ggplot(D, aes(age,  activeTransportTime)) + geom_bar(aes(fill=sex), stat = "identity", position = "dodge")
p + coord_cartesian(ylim = c(0.75, 1.05))
```

These data were ripped out of the EXCEL workbook and vary per scenario.
```{r transportData, eval = FALSE, echo = FALSE}

transportMode <- c("walk","cycle","bus","minibus","train","car.driver","car.passenger","mbike","elec.bike.scooter","LGV","HGV.rigid","HGV.articulated")

speed <- c(1.35299774571063,5.39374775150058,5.22298847623309,NA,9.94147658251227,17.36906017290580,14.51012134295660,NA,NA,NA,NA,NA)

dist <- c(2.44072161538462,1.19969769230769,4.37851867307692,NA,5.58545353846154,111.91985351923100,39.12264265384620,0.00000000000000,0.00000000000000,NA,1.05479452054795,NA) # miles per week

Data.Speed <- data.frame(speed,dist, row.names = transportMode)
```

```{r headDataSpeed, eval = FALSE}
Data.Speed
```

```{r transportTime, echo = FALSE, results = "hide", eval = FALSE}
head(transportTime <- Data.Speed$dist/Data.Speed$speed*60)
```



### Emissions Data



```{r roadAndCO2Data, echo = FALSE, eval = FALSE, results = "hide"}

CO2 <- c(957.686509527760,221.578783667454,203.624526028894,247.869842164617,333.468424533125,90.000000000000,835.014773125786)

Data.CO2 <- data.frame(CO2, row.names = c("bus","Cars.urban","Cars.mway","LGVs.urban","LGVs.mway","motorbike","HGV"))

Data.RoadType <- data.frame(local=c(0.75,0.53,0.0,0.09,0.29,NA,0.09,NA), arterial=c(0.25,0.47,0.96,0.31,0.42,NA,0.31,NA), highway=c(0.0,0,0.04,0.60,0.29,NA,0.60,NA),row.names=c("walk","cycle","bus","car","HGV","LGV","mbike","elec.bike") )

Data.Occupancy <- data.frame(occupancy = c(1.0,1.0,18.9,1.3,1.0,NA,1.0,NA), row.names = c("walk","cycle","bus","car","HGV","LGV","mbike","elec.bike"))

```

The amount of carbon emissions varies by transport mode and road type.
To accomodate this we need the distribution of road type by transport
mode.  At some point we need the expected number of passengers per
transport mode and we create it here, arbitrarily perhaps.

```{r showData, echo = TRUE, eval = FALSE, results = "show"}
Data.CO2
Data.RoadType
Data.Occupancy
```


### Non-(Active Transport) METs

The file NonTravelMETs.csv was created from the tripleWin EXCEL file.
These data are used in a table look-up for a given county.  The data
represent the non-travel-related energy expenditures as measured in
METs.  The data are stratified by age and sex.  Variable names were
not given for the 7 numerical variables listed.  Here we name them x1
through x7.

```{r nonTravelMETs, eval = FALSE, echo = FALSE}
nonTravelMETs <- data.frame(scan(file="./data/NonTravelMETs.csv", sep = ",", what = list("","","","",1,1,1,1,1,1,1), skip = 1))
names(nonTravelMETs) <- c("ID","sexcat","agecat2","GESTFIPS", paste0("x",1:7))
```

```{r ggplot, fig.width=12, fig.height=12, echo = FALSE, message = FALSE, warning = FALSE, results = "hide", eval = FALSE}
D <- melt(nonTravelMETs)
p <- ggplot(D, aes(x = variable, y = value, colour = agecat2), outlier.colour = "red", outlier.shape = 1 )
p + geom_boxplot()
```

Who is the outlier?  Perhaps it is a cohort of laborers, e.g., a county of coal miners?

```{r foo, eval = FALSE, echo = TRUE}
nonTravelMETs[which.max(nonTravelMETs$x5),]
```

Strange that it is group of middle-aged men.  I see this as a red
flag.  I remove this datum and redraw the boxplots, but this time only
for x5, x6 and x7, the others seemed less interesting.

```{r fips, eval = FALSE, echo = FALSE, results = "hide"}
fips <- read.csv("./data/fips_codes_website.csv")
any(fips$County.FIPS.Code==38)
```

```{r Nontravelmets, echo = FALSE, message = FALSE, warning = FALSE, results = "hide", fig.width=12, fig.height=6, eval = FALSE}
D <- melt(nonTravelMETs[-which.max(nonTravelMETs$x5),-(5:8)])
p <- ggplot(D, aes(x = variable, y = value, colour = agecat2), outlier.colour = "red", outlier.shape = 1 ) + geom_boxplot()

p + facet_grid(. ~ sexcat)
```

Thoughts?

### Relative Risk of MET Exposure

In the worksheet _Phy activity RRs_ we see estimates for relative risk
for various disease outcomes.  My guess is that some transformation is
being made to convert the exposure from active transport time to METs.
I don't know why this is needed yet.  I can't make much progress here
until I understand that better.

### Coefficient of Variation

An estimate for the coefficient of variation is provided without much
explanation.  The literature cites an empirical result.  The feeling
is that as mean active transport increases in the population people
are fitter and there is less variance in active transport time.  I
guess this has been shown in the same refernce for the coefficient of
variation estimate.

### Vital Statistics Data


#### 2001 Data with Vargo Script

```{r vitalstats, eval = FALSE, echo = FALSE}
source("../vargo/process_2001_vital_stats.r")
saveRDS(mortality2001, file = "./data/mortality2001.rds")
```


#### 2011 (VS11MORT.DUSMCPUB)

Lets read in the CDC data using the file VS11MORT.DUSMCPUB and see whats up.

```{r VS11, echo = FALSE, eval = FALSE}
tapePosition <- list(state = c(29:30), skippedVars = c(31:34), county = c(35:37), skippedVars = c(38:68), sex = 69, ageUnit = 70, ageValue = c(71:73), skippedVars = c(74:145), ICD = c(146:149), skippedVars = c(150:444), race = c(445:446)) # Magic number!!!
colClasses <- c("factor","factor","factor", "factor","integer", "character", "factor")
fileWidth <- 488 # Magic number!!!
```

```{r VS11Classes, echo = FALSE, eval = FALSE}
names(colClasses) <- names(tapePosition)[-which(names(tapePosition)=="skippedVars")]
colClasses
```

To include more variables edit the above lines.  The variable listed
must be contiguous.

```{r convertAge, warning = FALSE, eval = FALSE, echo = FALSE}

varWidths <- unlist(lapply(tapePosition, "length"))
varWidths <- ifelse(names(tapePosition) == "skippedVars", -varWidths, varWidths)
widths <- c(-(min(tapePosition[[1]])-1),c(varWidths))
widths <- c(widths,-(fileWidth-sum(abs(widths))))

Data.Mortality <- read.fwf(file = "~/ITHIM/R/data/VS11MORT.DUSMCPUB.first100", widths = widths, col.names = names(colClasses), header = FALSE, colClasses = colClasses)
Data.Mortality <- data.frame(Data.Mortality, convertedAge = with(Data.Mortality, convertAge(value = ageValue, unit = ageUnit)))

p <- ggplot(Data.Mortality, aes(x = convertedAge)) + geom_histogram(binwidth = 1)
p + facet_grid(. ~ sex)

```

```{r ICD, fig.width = 12, echo = FALSE, eval = FALSE}
Data.IDC.Codes <- read.csv(file="./data/IDC_Codes_key.csv", header = TRUE, colClasses = c("character","character","character"), na.string = "")
Data.IDC.Codes <- subset(Data.IDC.Codes, Include == "1" & !is.na(ITHIMCause))
ITHIMCauseOfDeath <- Data.IDC.Codes$ITHIMCause
names(ITHIMCauseOfDeath) <- Data.IDC.Codes$cause.of.death
Data.Mortality <- data.frame(Data.Mortality, CauseofDeathITHIM = ITHIMCauseOfDeath[Data.Mortality$ICD])
Data.Mortality <- subset(Data.Mortality, !is.na(CauseofDeathITHIM) & !is.na(convertedAge))
D <- data.frame(disease = Data.Mortality$CauseofDeathITHIM)
p <- ggplot(D, aes(disease))
p + geom_bar()

```

```{r CoDTable, eval = FALSE}
with(Data.Mortality, table(CauseofDeathITHIM))
```

```{r ageClass, fig.width = 12, echo = FALSE, eval = FALSE}
ageClass <- c(rep("00-04",5),rep("05-14",10),rep("15-29",15),rep("30-44",15),rep("45-59",15),rep("60-69",10),rep("70-79",10),rep("80+",121))
names(ageClass) <- as.character(0:200)
Data.Mortality <- data.frame(Data.Mortality, ageClass = as.factor(ageClass[as.character(as.integer(Data.Mortality$convertedAge))]))
with(Data.Mortality, table(ageClass))

D <- data.frame(ageClass = Data.Mortality$ageClass, disease = Data.Mortality$CauseofDeathITHIM)
p <- ggplot(D, aes(disease))
p + geom_bar(aes(fill=ageClass))
```

```{r histbyDisease, fig.width = 12, echo = FALSE, eval = FALSE}
D <- data.frame(convertedAge = Data.Mortality$convertedAge, disease = Data.Mortality$CauseofDeathITHIM)
p <- ggplot(D, aes(convertedAge, ..density.., colour = disease)) + geom_histogram(binwidth=5, show.legend = TRUE)
p + facet_grid( . ~ disease)
```

```{r counties, eval = FALSE}
Data.AgeSex <- read.csv("./data/county_age_sex2002.csv", header=T, col.names = c("county.name","state.name", "MSA","sex","all.ages","age0-4","age5-14","age15-29","age30-44","age45-59","age60-69","age70-79","age80+", "STATE","COUNTY"), colClasses = c("factor","factor","factor","factor","integer","integer","integer","integer","integer","integer","integer","integer","integer", "factor", "factor"))

age.sex.2 <- melt(age.sex[,c(14,15,4,6:13)], id=c("STATE","COUNTY","sex"))

#age.sex.3 <- dcast(age.sex.2, STATE + COUNTY + variable ~ sex, mean)

mort.age <- merge(mort.ITHIM, age.sex.3, by.x=c("state","county", "ITHIM.age"), by.y=c("STATE","COUNTY","variable"))

mort.age$year <- 2001

mort.age$app.pop <- ifelse(mort.age$sex ==1, mort.age$male, mort.age$female)

```

```{r tabulate, eval = FALSE}
Data.Mortality.Table <- as.data.frame(ftable(with(Data.Mortality, table(sex,ageClass,CauseofDeathITHIM))))
```

```{r saveMortality, echo = FALSE, eval = FALSE}
saveRDS(object = Data.Mortality, file = "./data/Data.Mortality.rds")
saveRDS(object = Data.Mortality.Table, file = "./data/Data.Mortality.Table.rds")
```

### Appendix

```{r appendix}
date()
sessionInfo()
```
